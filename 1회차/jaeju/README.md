# 도커를 공부해보자



## 발표 주제들

아래 발표 주제들에 대하여 학습하고 싶은 데까지 자유롭게 학습하고, 자유로운 양식으로 발표를 준비해 봅시다. 그림을 그리며 순서와 흐름을 파악해 볼 것을 추천드립니다.

- 기존 VM와 도커 사이의 OS관점에서 구조적 차이
- 도커 client-server 구조
- 도커 이미지, Dockerfile



## 기존 VM과 도커 사이의 OS 관점에서 구조적 차이

기존 가상화 기술(VirtualBox, VMware 등)은 하이퍼바이저를 통해 여러 운영체제를 하나의 호스트에서 생성하는 방식이다. 여러 개의 운영체제는 가상머신이라는 단위로 구분되고, 각 가상머신에 운영체제가 설치되어 사용된다. 하이퍼바이저에 의해 생성/관리되는 운영체제는 Guest OS라고 하며, 다른 운영체제와는 완전히 독립된 공간과 시스템 자원을 할당받아 사용된다. 가상머신은 완벽한 운영체제를 생성할 수 있다는 장점은 있지만, 일반 호스트에 비해 성능 손실이 있고, 수 기가바이트에 달하는 가상머신 이미지를 애플리케이션으로 배포하기는 부담스럽다는 단점이 있다.

반면 도커 컨테이너는 가상화된 공간을 생성하기 위해 리눅스의 자체 기능인 chroot(프로세스가 실행되는 루트를 변경하는 것), namespace, cgroup 등을 사용하여 프로세스 단위의 격리 환경을 만들어 구동한다(호스트 OS 입장에서 컨테이너는 단순한 하나의 프로세스). 컨테이너에 필요한 커널은 호스트의 커널을 공유해 사용하고, 컨테이너 안에는 애플리케이션을 구동하는데 필요한 라미어브리 및 실행 파일만 존재하기 때문에 컨테이너를 이미지로 만들었을 때 이미지의 용량 또한 가상 머신에 비해 대폭 줄어든다. CPU나 메모리는 딱 프로세스가 필요한 만큼만 추가로 사용하고 성능적으로도 거의 손실이 없다.

![What is Docker Used For? A Docker Container Tutorial for Beginners](https://www.freecodecamp.org/news/content/images/2020/11/image-166.png)





## 도커 client-server 구조

- docker client

일반적으로 작성하는 docker 명령어의 주인. CLI같은 명령행 인터페이스로 Docker Server에 명령을 하는 역할. 무조건 cli만 있는 것은 아니고, GUI를 통한 docker client도 제공. 실제로 docker deamon이 실행되고 있지 않은 상태에서 docker 명령을 내리면, `Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?`와 같은 메시지가 노출된다. Docker daemon이 실행 중이지 않은 상태이다.

- docker daemon(dockerd)

지속적으로 running 되면서 docker cli의 요청을 기다리고 docker 프로세스들을 관리한다. 데몬은 Docker를 관리하기 위해 다른 데몬과 통신할 수도 있다. 위 메시지를 보면 알겠지만, Docker 데몬과 클라이언트 간 통신을 할 때 로컬에서는 유닉스 소켓을 사용하고, 원격에서는 TCP소켓을 사용한다. HTTP REST 형식으로 API가 구현되어 있다. 원격 registry에 통신하는 것도, 이미지들을 관리하는 것도, 접근하는 것도 핵심은 Host 머신의 Daemon이다. 



## 도커 이미지, Dockerfile

- Docker Image

도커 이미지란 컨테이너 실행에 필요한 파일과 설정 값 등을 포함하고 있는 것으로 상태 값을 가지지 않고, 변하지 않음(Immutable). 컨테이너는 이미지를 실행한 결과라고 볼 수 있고(예를 들어 이미지가 프로그램이라면 컨테이너는 프로세스), 추가되거나 변하는 값은 이미지에 영향을 미치는 것이 아니라 컨테이너에 저장됨. 즉, 한 이미지로는 실행시의 결과 값이 항상 일정하다. 이미지는 컨테이너를 실행하기 위한 모든 정보를 가지고 있기 때문에 더 이상 의존성 파일을 컴파일하고 이것저것 설치할 필요가 없다. 

- Dockerfile

도커는 이미지를 만들기 위해 Dockerfile이라는 파일에 자체 DSL(Domain-specific language) 언어를 사용하여 이미지 생성 과정을 적는다. 만약 서버에서 프로그램 실행을 위해 여러 의존성 패키지를 설치하고 설정파일을 만들었다면, 그 과정을 직접 진행하거나 메모장에 적어 관리하는 것이 아니라 Dockerfile로 관리하면 된다. 이 도커 파일을 통해서 docker image를 생성할 수 있고, 그 image를 통해서 container를 실행할 수 있는 구조. 또한, 이 이미지는 빌드된 결과물이기 때문에 용량이 커지는 경우도 많아 Docker hub 등 외부 registry 저장소를 통해 관리할 수 있다.

- 레이어 저장방식

도커 이미지는 컨테이너를 실행하기 위한 모든 정보를 가지고 있기 때문에 보통 용량이 크다. 처음 이미지를 다운 받는 것을 그렇다 치더라도, 기존 이미지에 파일 하나 추가했다고 수백메가를 다시 다운받는 것은 매우 비효율적이다. 이런 문제를 해결하기 위해 레이어(layer)라는 개념을 사용하여 유니온 파일 시스템으로 여러 레이어를 하나의 파일시스템으로 사용할 수 있게 해준다. ubuntu 이미지가 A + B + C의 집합이라면, ubuntu 이미지를 베이스로 만든 java 이미지는 A + B + C + java가 된다.
